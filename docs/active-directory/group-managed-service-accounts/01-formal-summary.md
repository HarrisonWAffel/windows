## Formal Summary

gMSA (Group Managed Service Accounts) are a type of service account offered by Microsoft Active Directory. Its primary 
benefit is automatic password management by the Windows OS, which reduces the overhead of managing these service accounts
considerably, as well as an ability to be used by multiple computers simultaneously. These service accounts are used by 
services running within, or interacting with, services within a Microsoft Windows Domain. Use cases vary, but these 
accounts can be used for database authentication (Microsoft SQL) as well as other domain services which require some 
form of identity validation.

gMSA’s are an aspect of Microsoft Active Directory, and require interaction with Active Directory Components. In order 
for gMSA’s to function properly they must contact a Domain Controller (DC), which is responsible for contacting the Key 
Distribution Center (KDC) and then computing and disseminating the account password.

gMSA’s can be associated with particular computer accounts, or with a more general security policy in which computer 
accounts are put within. gMSA’s are not used for user (human) authentication and login processes (hence the use of the
term ‘Service Account’). These service accounts are ideal for containerized environments at scale, as multiple
containers can operate with the same gMSA and therefore a request can be made from, or serviced by, any container using
that gMSA. This is ideal for any work load behind a load balancer.

Docker has provided support for gMSA’s for some time now via the `--security-opt` flag. When running containers manually
you may include this flag and provide a value in the form of `credentialspec=file://my_gmsa_creds.json`. This then
instructs the runtime to pass the contents of the provided metadata file to the container, so that processes inside may
utilize it. In this example `my_gmsa_creds.json` is a file generated by a powershell command,
`New-CredentialSpec -AccountName WebApp01 -Path "C:\MyFolder\my_gmsa_creds.json"`, and contains the details of the gMSA
account and the Active Directory Domain. These details are then used by a windows process named `ccg.exe`,
which communicates with a Domain controller to obtain the gMSA password. 
Similar functionality has been implemented into other container runtimes, such as Containerd.

In general, when working with gMSA’s and containers, five main components come into play:

1. The container runtime
2. `ccg.exe`, which communicates with a Domain Controller to get the gMSA password
3. The `ccg.exe` plugin used to retrieve the Domain Controller credentials
4. The Domain Controller
5. The Key Distribution Center

Kubernetes has also provided support for gMSA’s that can be used in pods. Kubernetes represents the container runtimes
`security-opt` flag within the security-context for a resource. The same JSON object used in the previous example
can be passed within the YAML to load the pod with the gMSA metadata.

Additionally, the Kubernetes SIG for Windows provides a Kubernetes web-hook and credential CRD that can be installed into a cluster
which aids in deploying pods which need access to gMSA credentials. The web-hook credential CRD closely mirrors the
format of the `credentialspec` file passed to docker in the previous example. The web-hook is responsible for the
following:

1. Ensuring that the service account a pod is created under has RBAC access to this credential
2. expanding the contents of the credential onto the pod spec definition.

The gMSA web-hook will look through any workloads which specify a `windowsOptions` field and a subfield for gMSA’s
(`gmsaCredentialSpecName`) and expand the needed metadata onto any resulting pod specs. While it is titled a
‘gMSA Web-hook’ it is not strictly required for gMSA in Kubernetes to work, though it does offer convenience when using
gMSA's in containers and can remove human error when creating deployments. 

The web-hooks failure policy is set to “Fail”, which can result in significant problems. In the event that the web-hook goes
down for any reason, Kubernetes will report errors when handling subsequent operations as one of the required web-hooks
is no longer available.

This problem actually results in a chicken and the egg situation, wherein if the gMSA web-hook is terminated, and a new one
cannot be raised due to that same web-hook being unavailable. This is a significant consideration when putting the chart
into GA and using it in production. We likely need to either reduce the severity of the failure policy, so as not to break
the entire cluster (with the side effect being the nullification of the validation done by the web-hook),
or define a reliable resolution path for clusters encountering issues with this policy due to web-hook outages.

When using gMSA’s there are considerations that must be made in regard to the configuration and networking of your
Kubernetes cluster. Traditionally, gMSA support required that the host node be joined to the Active Directory Domain.
The process of 'Joining' a Domain is equivalent to logging into that Domain and obtaining a session. 
This is required because a Domain Controller will need to be contacted to perform password management and grant
Kerberos tickets. This requirement adds considerable overhead to cluster creation and limits rapid node
scalability for windows workloads, as joining a host to a domain requires a reboot among other things.

In response to this, Microsoft has developed the concept of a gMSA plugin which can integrate with `ccg.exe`. This
largely undocumented plugin functionality can be leveraged to retrieve gMSA credentials on non-domain joined nodes.
In essence, the plugin simply retrieves the required information from an object store, as opposed to retrieving it from
the host directly, and passes it to `ccg.exe`. `ccg.exe` then contacts a Domain Controller from within the host and
provides the gMSA password to the pod.

This helps with node scalability, however there is very little support on how to use this plugin feature or how to
install the actual application which would retrieve the credentials. Microsoft's only documentation on this feature
relates to using AKS, and leaves supporting any other configuration as an exercise for the reader. This results in many
rolling their own plugin and installing it onto the hosts as needed. While not perfect, and fairly complicated, this
process is more easily automated than the traditional setup as a single preconfigured OS image can be used when
scaling nodes. This approach is currently used by AKS and EKS to handle this bootstrapping problem.

From the perspective of Rancher, our support for gMSA largely stops at the deployment and management of the required
web-hook and related CRDs, as well as the development of a gMSA plugin for non-domain joined nodes - as one does not
already readily exist which can be used within Rancher. Issues with the web-hook behavior, how the credential is passed
into the pod, or how the gMSA password is retrieved from a Domain Controller should be raised with the respective
upstream component.

In summary, gMSA support on Kubernetes is fully supported and valuable to many companies containerizing their existing
AD applications. The complexity comes with how a pod communicates with the Active Directory Controller so that the
credentials can be accessed and authenticated. There exist two options: One, wherein a node is joined into the Windows
domain, and another where a plugin is used to retrieve the credentials outside the domain. In both cases the Kubernetes
SIG for Windows has provided a web-hook which can be used to facilitate the passing of domain credentials to pods. 


---

> [Continue to the next page](02-gmsa-overview-and-details.md) to learn more specifics about Group Managed Service Accounts